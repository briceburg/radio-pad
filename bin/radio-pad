#!/usr/bin/env python3
from prompt_toolkit import prompt
from prompt_toolkit.key_binding import KeyBindings
from python_mpv_jsonipc import MPV
import os, sys, subprocess
import urllib.request
import json
from time import sleep

AUDIO_CHANNELS = os.getenv("AUDIO_CHANNELS", "stereo")  # 'stereo' or 'mono'
RADIO_STATIONS_URL = os.getenv(
    "RADIO_STATIONS_URL",
    "https://raw.githubusercontent.com/briceburg/radio-pad/refs/heads/main/src/config/stations.json",
)

# cache radio stations
if not os.path.exists("/tmp/radio-pad-stations.json"):
    try:
        print(f"Downloading radio stations from {RADIO_STATIONS_URL} ...")
        urllib.request.urlretrieve(RADIO_STATIONS_URL, "/tmp/radio-pad-stations.json")
    except Exception as e:
        print(f"Error downloading radio stations: {e}")
        sys.exit(1)

with open("/tmp/radio-pad-stations.json", "r") as f:
    try:
        RADIO_STATIONS = json.load(f)
    except json.JSONDecodeError as e:
        print(f"Error parsing radio stations JSON: {e}")
        sys.exit(1)

bindings = KeyBindings()
mpv_process = None
mpv_sock = None
mpv_volume = None


def char_to_index(ch):
    """
    Convert a single character to an integer index:
    '0'-'9' -> 0-9, 'a'-'z' -> 10-35.
    """
    if ch.isdigit():
        return int(ch)
    elif "a" <= ch <= "z":
        return 10 + ord(ch) - ord("a")
    else:
        return None


def stop_station():
    global mpv_process
    global mpv_sock

    if mpv_sock:
        mpv_sock.stop()
        mpv_sock = None
        try:
            os.remove("/tmp/radio-pad-mpv.sock")
        except:
            pass

    if mpv_process:
        mpv_process.terminate()
        mpv_process = None


def play_station(station_index):
    global mpv_process
    global mpv_sock
    global mpv_volume

    station = RADIO_STATIONS[station_index]
    if mpv_process:
        print("Stopping current station...")
        stop_station()

    print(f"Playing {station['name']} from {station['url']} as {AUDIO_CHANNELS}.")
    mpv_process = subprocess.Popen(
        [
            "mpv",
            station["url"],
            "--no-osc",
            "--no-osd-bar",
            "--no-input-default-bindings",
            "--no-input-cursor",
            "--no-input-vo-keyboard",
            "--no-input-terminal",
            "--no-audio-display",
            "--input-ipc-server=/tmp/radio-pad-mpv.sock",
            "--no-video",
            "--no-cache",
            "--stream-lavf-o=reconnect_streamed=1",
            "--profile=low-latency",
            f"--audio-channels={AUDIO_CHANNELS}",
        ],
        stdin=subprocess.DEVNULL,
        stdout=sys.stdout,
        stderr=subprocess.STDOUT,
    )

    for i in range(10):
        try:
            mpv_sock = MPV(start_mpv=False, ipc_socket="/tmp/radio-pad-mpv.sock")
            # persist the previously set volume across mpv instances
            if mpv_volume is not None:
                mpv_sock.volume = mpv_volume
            return
        except Exception as e:
            sleep(0.10)

    print("failed to establish mpv IPC. volume controls disabled")
    mpv_sock = None


def volume_adjust(amt):
    global mpv_sock
    global mpv_volume
    if mpv_sock is None:
        return

    if mpv_volume is None:
        mpv_volume = mpv_sock.volume

    volume = mpv_volume + amt

    # keep volume from getting too high or too low
    if volume > 100:
        volume = 100
    elif volume < 50:
        volume = 50

    mpv_volume = volume
    mpv_sock.volume = mpv_volume
    print(f"  Adjusted Volume: {mpv_volume}")


@bindings.add("c-^", "up", record_in_macro=False)
def _(event):
    volume_adjust(5)


@bindings.add("c-^", "down", record_in_macro=False)
def _(event):
    volume_adjust(-5)


@bindings.add("c-@", "<any>", "<any>", record_in_macro=False)
def _(event):
    page_char = event.key_sequence[-2].data
    station_char = event.key_sequence[-1].data
    page_idx = char_to_index(page_char)
    station_idx = char_to_index(station_char)

    if page_idx is None or station_idx is None:
        print(f"Invalid input: Page: {page_char}, Station: {station_char}.")
        return

    stations_per_page = (
        12  # Assuming 12 stations per page, align this with macropad configuration
    )
    station_index = page_idx * stations_per_page + station_idx
    if station_index < 0 or station_index >= len(RADIO_STATIONS):
        print(
            f"Invalid station index: {station_index}. Page: {page_char}, Station: {station_char}."
        )
        return

    play_station(station_index)


while True:
    try:
        print("Press 'Control + @' followed by the radio page and station id.")
        print("Press 'Control + C' or 'Control + D' to exit.")
        prompt(key_bindings=bindings)
    except (KeyboardInterrupt, EOFError):
        print("Exiting...")
        stop_station()
        sys.exit(0)
